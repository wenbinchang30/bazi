<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>八字命理線上報表系統 - 進階版</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lunar Javascript (核心八字算法庫) -->
    <script src="https://unpkg.com/lunar-javascript@1.6.12/lunar.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&family=Noto+Sans+TC:wght@300;400;500&display=swap');
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #fdfbf7;
            color: #2c2c2c;
        }
        .serif {
            font-family: 'Noto Serif TC', serif;
        }
        /* 列印樣式 */
        @media print {
            .no-print { display: none; }
            body { background: white; }
            .print-break { page-break-before: always; }
            .card { border: 1px solid #ddd; box-shadow: none; break-inside: avoid; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- 輔助函式 ---
        const toTraditional = (str) => {
            if (!str) return "";
            return String(str)
                .replace(/财/g, '財').replace(/伤/g, '傷').replace(/杀/g, '殺').replace(/枭/g, '梟')
                .replace(/见/g, '見').replace(/贝/g, '貝').replace(/马/g, '馬').replace(/龙/g, '龍')
                .replace(/鸡/g, '雞').replace(/猪/g, '豬').replace(/门/g, '門').replace(/车/g, '車');
        };

        // --- 資料常數 ---
        const COLORS = {
            '金': { text: 'text-yellow-600', bg: 'bg-yellow-100', hex: '#d97706', suggest: '白色、金色' },
            '木': { text: 'text-green-600', bg: 'bg-green-100', hex: '#16a34a', suggest: '綠色、青色' },
            '水': { text: 'text-blue-600', bg: 'bg-blue-100', hex: '#2563eb', suggest: '黑色、藍色' },
            '火': { text: 'text-red-600', bg: 'bg-red-100', hex: '#dc2626', suggest: '紅色、紫色' },
            '土': { text: 'text-amber-700', bg: 'bg-amber-100', hex: '#b45309', suggest: '黃色、棕色' }
        };

        const DIRECTION_SUGGESTIONS = {
            '金': '西方、西北方', '木': '東方、東南方', '水': '北方', '火': '南方', '土': '中央、本地'
        };

        const CAREER_SUGGESTIONS = {
            '金': '金融、機械、汽車、軍警、外科', '木': '教育、出版、園藝、醫療、公務',
            '水': '貿易、物流、媒體、自由業', '火': '科技、餐飲、演藝、美容', '土': '地產、建築、農業、顧問'
        };

        const WEALTH_MAP = { '木': '土', '火': '金', '土': '水', '金': '木', '水': '火' };

        const GAN_INFO = {
            '甲': { wx: '木', yy: 1 }, '乙': { wx: '木', yy: 0 },
            '丙': { wx: '火', yy: 1 }, '丁': { wx: '火', yy: 0 },
            '戊': { wx: '土', yy: 1 }, '己': { wx: '土', yy: 0 },
            '庚': { wx: '金', yy: 1 }, '辛': { wx: '金', yy: 0 },
            '壬': { wx: '水', yy: 1 }, '癸': { wx: '水', yy: 0 }
        };

        const WUXING_RELATION = {
            '木': { sheng: '火', ke: '土' }, '火': { sheng: '土', ke: '金' },
            '土': { sheng: '金', ke: '水' }, '金': { sheng: '水', ke: '木' },
            '水': { sheng: '木', ke: '火' }
        };

        // --- 核心運算函式 ---
        const calculateShiShenManual = (dayMasterStr, targetStr) => {
            const dm = GAN_INFO[toTraditional(dayMasterStr)];
            const tg = GAN_INFO[toTraditional(targetStr)];
            if (!dm || !tg) return null;

            const isSameYinYang = dm.yy === tg.yy;
            const dmWx = dm.wx;
            const tgWx = tg.wx;

            if (dmWx === tgWx) return isSameYinYang ? '比肩' : '劫財';
            if (WUXING_RELATION[dmWx].sheng === tgWx) return isSameYinYang ? '食神' : '傷官';
            if (WUXING_RELATION[dmWx].ke === tgWx) return isSameYinYang ? '偏財' : '正財';
            if (WUXING_RELATION[tgWx].ke === dmWx) return isSameYinYang ? '七殺' : '正官';
            if (WUXING_RELATION[tgWx].sheng === dmWx) return isSameYinYang ? '偏印' : '正印';
            return null;
        };

        const safeGetWuXing = (obj) => {
            if (typeof obj?.getWuXing === 'function') return toTraditional(obj.getWuXing());
            if (typeof obj === 'string') {
                const map = {'甲':'木','乙':'木','丙':'火','丁':'火','戊':'土','己':'土','庚':'金','辛':'金','壬':'水','癸':'水'};
                return map[toTraditional(obj)] || '土';
            }
            return '土';
        };

        const safeGetName = (obj) => {
            if (typeof obj?.getName === 'function') return toTraditional(obj.getName());
            return toTraditional(String(obj || ''));
        };

        const safeGetHideGan = (zhi) => {
            if (typeof zhi?.getHideGan === 'function') return zhi.getHideGan();
            if (typeof zhi?.getHiddenGan === 'function') return zhi.getHiddenGan();
            return [];
        }

        // --- React 組件 ---

        function App() {
            const [formData, setFormData] = useState({
                year: 1990, month: 6, day: 15, hour: 12, minute: 30,
                gender: 1, longitude: 120.0, useTrueSolar: true
            });
            const [result, setResult] = useState(null);
            const [errorMsg, setErrorMsg] = useState('');
            const [isLibraryReady, setIsLibraryReady] = useState(false);

            useEffect(() => {
                if (window.Solar && window.Lunar) setIsLibraryReady(true);
                else {
                    const t = setInterval(() => {
                        if (window.Solar && window.Lunar) { setIsLibraryReady(true); clearInterval(t); }
                    }, 500);
                    return () => clearInterval(t);
                }
            }, []);

            const calculateBazi = () => {
                setErrorMsg(''); setResult(null);
                try {
                    if (!window.Solar) throw new Error("核心庫未載入");
                    
                    let { year, month, day, hour, minute, longitude, useTrueSolar, gender } = formData;
                    year = parseInt(year); month = parseInt(month); day = parseInt(day);
                    hour = parseInt(hour); minute = parseInt(minute);

                    if (useTrueSolar) {
                        const offset = (parseFloat(longitude) - 120) * 4;
                        const d = new Date(year, month - 1, day, hour, minute);
                        d.setMinutes(d.getMinutes() + offset);
                        year = d.getFullYear(); month = d.getMonth() + 1; day = d.getDate();
                        hour = d.getHours(); minute = d.getMinutes();
                    }

                    const solar = Solar.fromYmdHms(year, month, day, hour, minute, 0);
                    const lunar = Lunar.fromSolar(solar);
                    const eightChar = lunar.getEightChar();
                    const yun = eightChar.getYun(gender);
                    const wuxingScores = { '金': 0, '木': 0, '水': 0, '火': 0, '土': 0 };

                    // 五行計分
                    const countWuxing = (obj, w) => { wuxingScores[safeGetWuXing(obj)] += w; };
                    countWuxing(eightChar.getYearGan(), 10);
                    countWuxing(eightChar.getMonthGan(), 10);
                    countWuxing(eightChar.getDayGan(), 10);
                    countWuxing(eightChar.getTimeGan(), 10);

                    [eightChar.getYearZhi(), eightChar.getMonthZhi(), eightChar.getDayZhi(), eightChar.getTimeZhi()].forEach(z => {
                        safeGetHideGan(z).forEach(g => countWuxing(g, 5)); // 簡化藏干權重
                    });

                    const dayMaster = eightChar.getDayGan();
                    const dmWuXing = safeGetWuXing(dayMaster);
                    
                    const sheng = WUXING_RELATION[dmWuXing].sheng; // 我生
                    const ke = WUXING_RELATION[dmWuXing].ke; // 我剋
                    const beSheng = Object.keys(WUXING_RELATION).find(k => WUXING_RELATION[k].sheng === dmWuXing); // 生我
                    const beKe = Object.keys(WUXING_RELATION).find(k => WUXING_RELATION[k].ke === dmWuXing); // 剋我

                    const sameScore = wuxingScores[dmWuXing];
                    const resourceScore = wuxingScores[beSheng];
                    const selfStrength = sameScore + resourceScore;
                    const opposeStrength = wuxingScores[sheng] + wuxingScores[ke] + wuxingScores[beKe];
                    
                    const isStrong = selfStrength >= opposeStrength;
                    
                    // 喜用神判定 (簡易邏輯)
                    let usefulGods = [], avoidGods = [];
                    if (isStrong) {
                        usefulGods = [ke, beKe, sheng]; // 喜財、官、食傷
                        avoidGods = [dmWuXing, beSheng]; // 忌比劫、印
                    } else {
                        usefulGods = [beSheng, dmWuXing]; // 喜印、比劫
                        avoidGods = [ke, beKe, sheng]; // 忌財、官、食傷
                    }

                    setResult({ solar, lunar, eightChar, yun, wuxingScores, dayMaster, isStrong, usefulGods, avoidGods, dmWuXing });
                } catch (e) {
                    console.error(e);
                    setErrorMsg("計算錯誤，請檢查輸入日期。");
                }
            };

            return (
                <div className="min-h-screen pb-10 bg-slate-50">
                    <header className="bg-slate-900 text-amber-50 py-6 px-4 shadow-md no-print">
                        <div className="max-w-5xl mx-auto flex justify-between items-center">
                            <div>
                                <h1 className="text-2xl font-bold serif tracking-wider">八字命理線上報表</h1>
                                <p className="text-sm text-slate-400 mt-1">進階命格交互分析 | 大運流年量化評分</p>
                            </div>
                            <button className="text-sm bg-amber-700 hover:bg-amber-600 px-4 py-2 rounded text-white" onClick={() => window.print()}>列印報告</button>
                        </div>
                    </header>

                    <main className="max-w-5xl mx-auto p-4 space-y-8">
                        {/* 輸入區 */}
                        <section className="card bg-white p-6 rounded-lg shadow-sm border border-slate-200 no-print">
                            <h2 className="text-lg font-bold border-b pb-2 mb-4 text-slate-700">1. 輸入資料</h2>
                            {!isLibraryReady && <div className="text-yellow-600 mb-2">載入運算庫中...</div>}
                            <div className="grid grid-cols-2 md:grid-cols-6 gap-3 text-sm">
                                <input type="number" className="border p-2 rounded" value={formData.year} onChange={e=>setFormData({...formData, year:e.target.value})} placeholder="年" />
                                <select className="border p-2 rounded" value={formData.month} onChange={e=>setFormData({...formData, month:e.target.value})}>{[...Array(12).keys()].map(i=><option key={i} value={i+1}>{i+1}月</option>)}</select>
                                <select className="border p-2 rounded" value={formData.day} onChange={e=>setFormData({...formData, day:e.target.value})}>{[...Array(31).keys()].map(i=><option key={i} value={i+1}>{i+1}日</option>)}</select>
                                <select className="border p-2 rounded" value={formData.hour} onChange={e=>setFormData({...formData, hour:e.target.value})}>{[...Array(24).keys()].map(i=><option key={i} value={i}>{i}時</option>)}</select>
                                <input type="number" className="border p-2 rounded" value={formData.minute} onChange={e=>setFormData({...formData, minute:e.target.value})} placeholder="分" />
                                <select className="border p-2 rounded" value={formData.gender} onChange={e=>setFormData({...formData, gender:parseInt(e.target.value)})}>
                                    <option value={1}>男</option><option value={0}>女</option>
                                </select>
                            </div>
                            <div className="mt-2">
                                <label className="flex items-center gap-2 text-sm text-gray-600">
                                    <input type="checkbox" checked={formData.useTrueSolar} onChange={e=>setFormData({...formData, useTrueSolar:e.target.checked})} /> 啟用真太陽時 (需輸入經度)
                                </label>
                            </div>
                            {errorMsg && <div className="text-red-500 mt-2 text-sm">{errorMsg}</div>}
                            <button onClick={calculateBazi} disabled={!isLibraryReady} className="w-full mt-4 bg-slate-800 text-white py-2 rounded hover:bg-slate-700">開始分析</button>
                        </section>

                        {result && (
                            <>
                                <ChartDisplay result={result} />
                                <AnalysisSection result={result} />
                                <TenGodsInteractionSection result={result} />
                                <WealthSection result={result} />
                                <DaYunDetailSection result={result} />
                                <AdviceSection result={result} />
                                <footer className="text-center text-xs text-gray-400 mt-12 print-break">
                                    <p>命理僅供參考，命運掌握在自己手中。</p>
                                </footer>
                            </>
                        )}
                    </main>
                </div>
            );
        }

        // --- 子組件 ---

        function ChartDisplay({ result }) {
            const { eightChar, solar } = result;
            const dayGanStr = safeGetName(eightChar.getDayGan());
            
            const getShiShen = (ganStr) => {
                if (!ganStr || ganStr === dayGanStr) return '日主';
                return calculateShiShenManual(dayGanStr, ganStr) || '';
            };

            const pillars = [
                { t: '年', g: eightChar.getYearGan(), z: eightChar.getYearZhi() },
                { t: '月', g: eightChar.getMonthGan(), z: eightChar.getMonthZhi() },
                { t: '日', g: eightChar.getDayGan(), z: eightChar.getDayZhi() },
                { t: '時', g: eightChar.getTimeGan(), z: eightChar.getTimeZhi() }
            ];

            return (
                <section className="card bg-white p-6 rounded-lg shadow-sm border border-slate-200">
                    <div className="mb-4 text-slate-800 font-bold text-lg">2. 八字命盤</div>
                    <div className="grid grid-cols-4 gap-2 text-center border-t border-b py-4">
                        {pillars.map((p, i) => {
                            const gName = safeGetName(p.g);
                            const zName = safeGetName(p.z);
                            const gWx = safeGetWuXing(p.g);
                            const zWx = safeGetWuXing(p.z);
                            return (
                                <div key={i}>
                                    <div className="text-xs text-gray-400">{p.t}柱</div>
                                    <div className="text-xs text-amber-600 h-4">{getShiShen(gName)}</div>
                                    <div className={`text-2xl font-bold serif ${COLORS[gWx].text}`}>{gName}</div>
                                    <div className={`text-2xl font-bold serif ${COLORS[zWx].text}`}>{zName}</div>
                                    <div className="text-xs text-gray-400 flex flex-col mt-1">
                                        {safeGetHideGan(p.z).map((h, idx) => (
                                            <span key={idx} className="scale-90">{safeGetName(h)}</span>
                                        ))}
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </section>
            );
        }

        function AnalysisSection({ result }) {
            const { wuxingScores, isStrong, usefulGods, dmWuXing, avoidGods, dayMaster } = result;
            const max = Math.max(...Object.values(wuxingScores)) || 1;

            return (
                <section className="card bg-white p-6 rounded-lg shadow-sm border border-slate-200 grid md:grid-cols-2 gap-6">
                    <div>
                        <h3 className="font-bold text-slate-800 mb-2">3. 五行能量</h3>
                        {Object.entries(wuxingScores).map(([k, v]) => (
                            <div key={k} className="flex items-center text-sm mb-1">
                                <span className={`w-6 font-bold ${COLORS[k].text}`}>{k}</span>
                                <div className="flex-1 h-2 bg-gray-100 rounded-full mx-2">
                                    <div className={`h-full ${k==='金'?'bg-yellow-500':k==='木'?'bg-green-500':k==='水'?'bg-blue-500':k==='火'?'bg-red-500':'bg-amber-600'}`} style={{width: `${(v/max)*100}%`}}></div>
                                </div>
                                <span className="w-8 text-right">{v.toFixed(0)}</span>
                            </div>
                        ))}
                    </div>
                    <div>
                        <h3 className="font-bold text-slate-800 mb-2">4. 格局判定</h3>
                        <div className="bg-slate-50 p-3 rounded text-sm space-y-2">
                            <p>日主：<span className="font-bold">{safeGetName(dayMaster)}({dmWuXing})</span></p>
                            <p>強弱：<span className={isStrong ? 'text-red-600 font-bold' : 'text-blue-600 font-bold'}>{isStrong ? '身強 (Strong)' : '身弱 (Weak)'}</span></p>
                            <p>喜用：<span className="text-green-700 font-bold">{usefulGods.join('、')}</span></p>
                            <p>忌神：<span className="text-gray-500">{avoidGods.join('、')}</span></p>
                        </div>
                    </div>
                </section>
            );
        }

        // --- 核心邏輯：十神交互分析 (新功能) ---
        function TenGodsInteractionSection({ result }) {
            const { eightChar, isStrong } = result;
            const dmStr = safeGetName(eightChar.getDayGan());
            const counts = {};
            
            // 收集所有十神 (包含藏干)
            const allGans = [
                safeGetName(eightChar.getYearGan()), safeGetName(eightChar.getMonthGan()), safeGetName(eightChar.getTimeGan()),
                ...safeGetHideGan(eightChar.getYearZhi()).map(g=>safeGetName(g)),
                ...safeGetHideGan(eightChar.getMonthZhi()).map(g=>safeGetName(g)),
                ...safeGetHideGan(eightChar.getDayZhi()).map(g=>safeGetName(g)),
                ...safeGetHideGan(eightChar.getTimeZhi()).map(g=>safeGetName(g))
            ];

            allGans.forEach(g => {
                if (g && g !== dmStr) {
                    const ss = calculateShiShenManual(dmStr, g);
                    if (ss) {
                        // 歸類：食神傷官合稱「食傷」，正偏財合稱「財星」，官殺合稱「官殺」，印梟合稱「印星」，比劫合稱「比劫」
                        const groupMap = {
                            '食神': '食傷', '傷官': '食傷',
                            '正財': '財星', '偏財': '財星',
                            '正官': '官殺', '七殺': '官殺',
                            '正印': '印星', '偏印': '印星',
                            '比肩': '比劫', '劫財': '比劫'
                        };
                        const group = groupMap[ss];
                        counts[group] = (counts[group] || 0) + 1;
                        counts[ss] = (counts[ss] || 0) + 1; // 詳細計數
                    }
                }
            });

            // 找出最強勢的兩個十神族群
            const sortedGroups = Object.entries(counts)
                .filter(([k]) => ['食傷','財星','官殺','印星','比劫'].includes(k))
                .sort((a, b) => b[1] - a[1]);
            
            const top1 = sortedGroups[0];
            const top2 = sortedGroups[1];

            let analysisText = "您的八字結構較為均衡，無極端偏向。";
            let suggestion = "建議順應運勢，穩健發展。";

            if (top1) {
                const main = top1[0];
                const score = top1[1];
                
                if (main === '官殺') {
                    if (isStrong) {
                        analysisText = `【身強官殺旺】：這是標準的「主管/老闆格」。身強能任官殺之剋，代表您抗壓性強，有決斷力與執行力，天生具備領導威望。`;
                        suggestion = "適合在大型企業、公家機關發展，或自行創業擔任管理者。注意不要過於強勢霸道。";
                    } else {
                        analysisText = `【身弱官殺旺】：這稱為「官殺攻身」。您責任感過重，常感到壓力巨大，易犯小人或身體微恙，個性較為壓抑保守。`;
                        suggestion = "適合從事文職、幕僚或技術工作。必須先「強身」（多學習、依靠長輩），不宜強出頭承擔過大責任。";
                    }
                } else if (main === '財星') {
                    if (isStrong) {
                        analysisText = `【身強財星旺】：這是「富翁之格」。您有賺錢的能力與體力，對商機嗅覺敏銳，能將才華轉化為實質財富。`;
                        suggestion = "適合經商、業務、金融投資。大膽把握機會，但需注意財多傷印（忽略健康或名聲）。";
                    } else {
                        analysisText = `【身弱財星旺】：這叫「富屋貧人」。您身邊賺錢機會多，或整天經手大筆金錢（如會計），但自己卻難以留住，容易因財招禍或體力透支。`;
                        suggestion = "建議尋求合作（比劫分財），不要獨資。適合領固定高薪或穩定儲蓄，切勿從事高風險投機。";
                    }
                } else if (main === '食傷') {
                    if (isStrong) {
                        analysisText = `【身強食傷旺】：這是「才子/發明家格」。您聰明絕頂，反應快，口才好，喜歡自由發揮，不愛受拘束。`;
                        suggestion = "適合創意、行銷、演藝、講師、設計等需要展現個人魅力的行業。";
                    } else {
                        analysisText = `【身弱食傷旺】：這叫「泄身太過」。您思慮過多，容易神經質或想太多做太少，往往聰明反被聰明誤，體質較虛。`;
                        suggestion = "建議專精一項技能，不要太發散。多運動增強體力，並學習專注。";
                    }
                } else if (main === '印星') {
                    analysisText = `【印星旺】：${isStrong ? '身強印旺，稍微懶散依賴，貴人運好但較缺乏衝勁。' : '身弱印旺，得長輩庇蔭，喜好學習與精神層面，個性溫和。'}`;
                    suggestion = "適合從事學術、研究、教育、宗教或幕後策劃工作。需培養執行力。";
                } else if (main === '比劫') {
                    analysisText = `【比劫旺】：${isStrong ? '身強比劫旺，個性固執好勝，講義氣但也容易被朋友拖累破財。' : '身弱比劫旺，得朋友兄弟相助，適合合夥打拼。'}`;
                    suggestion = "適合團隊合作、連鎖加盟或體力相關工作。理財要保守，防範借貸不還。";
                }
            }

            return (
                <section className="card bg-white p-6 rounded-lg shadow-sm border border-slate-200">
                    <h2 className="text-lg font-bold text-slate-800 mb-4">5. 命格與十神交互分析</h2>
                    <div className="flex flex-col md:flex-row gap-6">
                        <div className="flex-1">
                            <div className="grid grid-cols-5 gap-2 text-center mb-4">
                                {['食傷','財星','官殺','印星','比劫'].map(g => (
                                    <div key={g} className="bg-slate-50 p-2 rounded border">
                                        <div className="text-xs text-gray-500">{g}</div>
                                        <div className="font-bold text-slate-800">{counts[g]||0}</div>
                                    </div>
                                ))}
                            </div>
                            <div className="p-4 bg-amber-50 rounded border border-amber-100">
                                <div className="font-bold text-amber-800 mb-2">格局判斷</div>
                                <p className="text-sm text-gray-700 leading-relaxed font-bold">{analysisText}</p>
                            </div>
                        </div>
                        <div className="flex-1">
                            <h4 className="font-bold text-slate-700 mb-2">交互影響詳解：</h4>
                            <p className="text-sm text-gray-600 leading-relaxed mb-4">{suggestion}</p>
                            <p className="text-xs text-gray-400">* 交互性分析結合了「日主強弱」與「十神多寡」，是論命的核心關鍵。單看十神數量而不論身強身弱是不準確的。</p>
                        </div>
                    </div>
                </section>
            );
        }

        function WealthSection({ result }) {
            // ... (保持原有的財運分析代碼) ...
            const { wuxingScores, dmWuXing, isStrong } = result;
            const wealthElement = WEALTH_MAP[dmWuXing];
            const wealthScore = wuxingScores[wealthElement] || 0;
            const maxScore = Math.max(...Object.values(wuxingScores)) || 1;
            const isWealthStrong = wealthScore > (maxScore * 0.2);
            
            let title, description;
            if (isStrong && isWealthStrong) { title = "身旺財旺 (大富)"; description = "身強能任財，且財星有力。適合創業、投資，財源廣進。"; }
            else if (isStrong && !isWealthStrong) { title = "身旺財弱 (技術求財)"; description = "身強但財星弱。宜靠一技之長或專業技術賺錢，不宜投機。"; }
            else if (!isStrong && isWealthStrong) { title = "財多身弱 (富屋貧人)"; description = "財星太旺反成壓力。宜合夥、保守，防因財傷身。"; }
            else { title = "身弱財弱 (知足常樂)"; description = "求財辛苦，宜上班領薪，積少成多，平淡是福。"; }

            return (
                <section className="card bg-white p-6 rounded-lg shadow-sm border border-slate-200 mt-6">
                    <h2 className="text-lg font-bold text-slate-800 mb-4">6. 財運專屬分析</h2>
                    <div className="flex justify-between items-center bg-yellow-50 p-4 rounded">
                        <div>
                            <div className="text-sm text-yellow-800">您的財星</div>
                            <div className="text-2xl font-bold text-yellow-600">{wealthElement}</div>
                        </div>
                        <div className="text-right">
                            <div className="font-bold text-slate-700">{title}</div>
                            <div className="text-sm text-gray-500">{description}</div>
                        </div>
                    </div>
                </section>
            );
        }

        // --- 核心邏輯：大運流年評分 (新功能) ---
        function DaYunDetailSection({ result }) {
            const { yun, usefulGods, avoidGods, eightChar } = result;
            const daYunArr = yun.getDaYun().slice(0, 8); // 取前8步大運
            const dmStr = safeGetName(eightChar.getDayGan());

            // 評分邏輯
            const getScore = (ganStr, zhiStr) => {
                const ganWx = safeGetWuXing(ganStr);
                const zhiWx = safeGetWuXing(zhiStr);
                let score = 60; // 基礎分
                
                // 天干權重 40%，地支權重 60%
                if (usefulGods.includes(ganWx)) score += 15;
                else if (avoidGods.includes(ganWx)) score -= 15;
                
                if (usefulGods.includes(zhiWx)) score += 25;
                else if (avoidGods.includes(zhiWx)) score -= 25;
                
                return Math.max(0, Math.min(100, score));
            };

            // 獲取建議文字
            const getAdvice = (ganStr, zhiStr, score) => {
                const tenGod = calculateShiShenManual(dmStr, ganStr);
                let type = "";
                if (score >= 80) type = "吉運";
                else if (score >= 60) type = "平運";
                else type = "凶運";

                const descMap = {
                    '比肩': '朋友互助，合作機會，但也易分財。',
                    '劫財': '社交活躍，需防破財或被朋友拖累。',
                    '食神': '心情愉快，口福好，適合學習新知。',
                    '傷官': '才華展現，但易犯口舌，工作變動大。',
                    '正財': '收入穩定，財運佳，適合保守理財。',
                    '偏財': '意外之財，投資機會，但起伏較大。',
                    '正官': '事業升遷，名聲佳，女命有利姻緣。',
                    '七殺': '壓力較大，責任重，需防血光或小人。',
                    '正印': '貴人相助，有利考運與置產。',
                    '偏印': '思想獨特，較孤僻，有利冷門偏業。'
                };

                return { type, desc: descMap[tenGod] || "運勢流轉，需謹慎行事。" };
            };

            return (
                <section className="card bg-white p-6 rounded-lg shadow-sm border border-slate-200 mt-6">
                    <h2 className="text-lg font-bold text-slate-800 mb-4">7. 大運流年量化詳解</h2>
                    <div className="space-y-4">
                        {daYunArr.map((dy, idx) => {
                            const gan = dy.getGanZhi().charAt(0);
                            const zhi = dy.getGanZhi().charAt(1);
                            const score = getScore(gan, zhi);
                            const info = getAdvice(gan, zhi, score);
                            
                            // 顏色樣式
                            let scoreColor = "bg-gray-200 text-gray-600";
                            if (score >= 80) scoreColor = "bg-red-100 text-red-700 border-red-200";
                            else if (score >= 60) scoreColor = "bg-yellow-100 text-yellow-700 border-yellow-200";
                            else scoreColor = "bg-slate-200 text-slate-600 border-slate-300";

                            return (
                                <div key={idx} className={`p-3 rounded border flex items-center justify-between ${scoreColor}`}>
                                    <div className="text-center w-16 border-r border-gray-300 pr-3">
                                        <div className="text-xs opacity-70">{dy.getStartAge()}歲起</div>
                                        <div className="text-xl font-bold serif">{dy.getGanZhi()}</div>
                                    </div>
                                    <div className="flex-1 px-4">
                                        <div className="flex justify-between mb-1">
                                            <span className="font-bold">{info.type} ({calculateShiShenManual(dmStr, gan)}運)</span>
                                            <span className="font-bold text-lg">{score}分</span>
                                        </div>
                                        <div className="text-sm opacity-90">{info.desc}</div>
                                        {/* 如果是凶運，加警語 */}
                                        {score < 60 && <div className="text-xs mt-1 font-bold">⚠️ 注意：此運勢較低迷，五行不調，建議保守守成，多行善積德。</div>}
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </section>
            );
        }

        function AdviceSection({ result }) {
            const { usefulGods } = result;
            return (
                <section className="card bg-white p-6 rounded-lg shadow-sm border border-slate-200 mt-6">
                    <h2 className="text-lg font-bold text-slate-800 mb-4">8. 開運指南</h2>
                    <div className="grid md:grid-cols-2 gap-4">
                        {usefulGods.map(wx => (
                            <div key={wx} className={`p-3 rounded border-l-4 ${wx==='木'?'border-green-500 bg-green-50':wx==='火'?'border-red-500 bg-red-50':wx==='土'?'border-amber-500 bg-amber-50':wx==='金'?'border-yellow-500 bg-yellow-50':'border-blue-500 bg-blue-50'}`}>
                                <div className="font-bold mb-1">補運五行：{wx}</div>
                                <div className="text-xs text-gray-600">
                                    <p>顏色：{COLORS[wx].suggest}</p>
                                    <p>方位：{DIRECTION_SUGGESTIONS[wx]}</p>
                                    <p>行業：{CAREER_SUGGESTIONS[wx]}</p>
                                </div>
                            </div>
                        ))}
                    </div>
                </section>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
