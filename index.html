<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°ˆæ¥­å…«å­—å‘½ç›¤ç³»çµ± (V2ä¿®æ­£ç‰ˆ)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lunar-javascript@1.6.12/lunar.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* äº”è¡Œé¡è‰²å®šç¾© */
        .bg-wood { background-color: #dcfce7; color: #166534; border: 1px solid #166534; }
        .bg-fire { background-color: #fee2e2; color: #991b1b; border: 1px solid #991b1b; }
        .bg-earth { background-color: #fef9c3; color: #854d0e; border: 1px solid #854d0e; }
        .bg-metal { background-color: #f3f4f6; color: #374151; border: 1px solid #374151; }
        .bg-water { background-color: #dbeafe; color: #1e40af; border: 1px solid #1e40af; }
        .font-bazi { font-family: "KaiTi", "STKaiti", serif; font-weight: bold; }
        /* å‹•ç•« */
        .fade-enter-active, .fade-leave-active { transition: opacity 0.5s; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

<div id="app" class="max-w-5xl mx-auto p-4">
    
    <header class="mb-8 text-center">
        <h1 class="text-3xl font-bold text-indigo-700 mb-2">ğŸ”® å°ˆæ¥­å…«å­—å‘½ç›¤ç³»çµ± V2</h1>
        <p class="text-gray-500 text-sm">å«çœŸå¤ªé™½æ™‚æ ¡æ­£ã€åç¥åˆ†æã€äº”è¡Œå¼·å¼±åœ–è¡¨</p>
    </header>

    <section class="bg-white p-6 rounded-xl shadow-md mb-8">
        <h2 class="text-xl font-semibold mb-4 border-l-4 border-indigo-500 pl-3">è¼¸å…¥è³‡æ–™</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            
            <div>
                <label class="block text-sm font-medium text-gray-700">å§“å</label>
                <input v-model="form.name" type="text" class="mt-1 block w-full rounded-md border-gray-300 border p-2" placeholder="è«‹è¼¸å…¥å§“å">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700">æ€§åˆ¥</label>
                <select v-model="form.gender" class="mt-1 block w-full rounded-md border-gray-300 border p-2">
                    <option :value="1">ç”· (ä¹¾é€ )</option>
                    <option :value="0">å¥³ (å¤é€ )</option>
                </select>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700">å‡ºç”Ÿæ—¥æœŸ (åœ‹æ›†)</label>
                <input v-model="form.date" type="date" class="mt-1 block w-full rounded-md border-gray-300 border p-2">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700">å‡ºç”Ÿæ™‚é–“</label>
                <div class="flex gap-2">
                    <select v-model="form.hour" class="w-1/2 rounded-md border p-2">
                        <option v-for="h in 24" :key="h-1" :value="h-1">{{ (h-1).toString().padStart(2,'0') }} æ™‚</option>
                    </select>
                    <select v-model="form.minute" class="w-1/2 rounded-md border p-2">
                        <option v-for="m in 60" :key="m-1" :value="m-1">{{ (m-1).toString().padStart(2,'0') }} åˆ†</option>
                    </select>
                </div>
            </div>

            <div class="lg:col-span-2">
                <label class="block text-sm font-medium text-gray-700">
                    å‡ºç”ŸåŸå¸‚ (çœŸå¤ªé™½æ™‚æ ¡æ­£)
                    <span class="text-xs text-indigo-600 ml-2 font-bold" v-if="trueSolarTimeStr">ğŸŒ çœŸå¤ªé™½æ™‚: {{ trueSolarTimeStr }}</span>
                </label>
                <div class="flex gap-2 mt-1">
                    <select v-model="selectedCity" @change="updateLocation" class="block w-1/2 rounded-md border-gray-300 border p-2">
                        <option value="custom">è‡ªè¨‚ç¶“åº¦</option>
                        <option v-for="city in cities" :key="city.name" :value="city">{{ city.name }}</option>
                    </select>
                    <input v-model.number="form.longitude" type="number" step="0.01" class="block w-1/2 rounded-md border-gray-300 border p-2" placeholder="ç¶“åº¦">
                </div>
            </div>

        </div>

        <div class="mt-6 text-center">
            <button @click="calculate" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-8 rounded-lg shadow w-full md:w-auto active:scale-95 transition">
                é–‹å§‹æ’ç›¤
            </button>
        </div>
    </section>

    <div v-if="result" class="animate-fade-in">
        
        <div class="bg-white p-4 rounded-xl shadow mb-6 flex flex-wrap justify-between items-center text-sm md:text-base">
            <div>
                <span class="font-bold text-gray-900 text-lg">{{ form.name || 'å‘½ä¸»' }}</span> 
                <span class="text-gray-300 mx-2">|</span>
                <span>{{ form.gender === 1 ? 'ä¹¾é€ ' : 'å¤é€ ' }}</span>
                <span class="text-gray-300 mx-2">|</span>
                <span>{{ result.zodiac }}å¹´</span>
            </div>
            <div class="text-gray-600 mt-2 md:mt-0 text-right">
                <div class="font-bold text-indigo-800">{{ result.lunarDate }}</div>
                <div class="text-xs">ç¯€æ°£ï¼š{{ result.solarTerm }}</div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow">
                <h3 class="text-lg font-semibold mb-4 text-gray-800">ğŸ—“ï¸ å››æŸ±å…«å­—</h3>
                <div class="grid grid-cols-4 gap-2 text-center">
                    <div class="text-gray-400 text-xs">å¹´æŸ±</div>
                    <div class="text-gray-400 text-xs">æœˆæŸ±</div>
                    <div class="text-indigo-600 text-xs font-bold">æ—¥æŸ± (ä¸»)</div>
                    <div class="text-gray-400 text-xs">æ™‚æŸ±</div>

                    <div v-for="(p, i) in result.pillars" :key="'god'+i" class="text-xs text-gray-500 h-5">{{ p.ganGod }}</div>

                    <div v-for="(p, i) in result.pillars" :key="'gan'+i" class="text-2xl md:text-3xl font-bazi py-2 rounded shadow-sm" :class="getColorClass(p.ganWX)">
                        {{ p.gan }}
                    </div>

                    <div v-for="(p, i) in result.pillars" :key="'zhi'+i" class="text-2xl md:text-3xl font-bazi py-2 rounded shadow-sm" :class="getColorClass(p.zhiWX)">
                        {{ p.zhi }}
                    </div>

                    <div v-for="(p, i) in result.pillars" :key="'hide'+i" class="text-xs text-gray-400 mt-2 leading-tight">
                        <div v-for="h in p.hidden" :key="h">{{ h }}</div>
                    </div>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow flex flex-col items-center">
                <h3 class="text-lg font-semibold mb-2 text-gray-800">âš–ï¸ äº”è¡Œèƒ½é‡</h3>
                <div class="relative h-64 w-full flex justify-center items-center">
                    <canvas id="fiveElementChart"></canvas>
                </div>
                <div class="mt-4 text-center text-sm">
                    <span class="bg-gray-100 px-2 py-1 rounded text-gray-600">æœ€å¼·ï¼š{{ result.scores.max.name }}</span>
                </div>
            </div>
        </div>

        <div class="mt-6 bg-white p-6 rounded-xl shadow overflow-x-auto">
            <h3 class="text-lg font-semibold mb-4 text-gray-800">ğŸŒŠ å¤§é‹ (æ¯åå¹´)</h3>
            <div class="flex min-w-max gap-3 pb-2">
                <div v-for="(yun, i) in result.daYun" :key="i" class="border border-gray-200 rounded-lg p-3 w-20 text-center hover:bg-indigo-50 transition cursor-default">
                    <div class="text-xs text-gray-400 mb-1">{{ yun.startAge }}æ­²</div>
                    <div class="flex flex-col gap-1 font-bazi text-lg">
                        <span :class="getColorText(yun.ganWX)">{{ yun.gan }}</span>
                        <span :class="getColorText(yun.zhiWX)">{{ yun.zhi }}</span>
                    </div>
                    <div class="text-[10px] text-gray-400 mt-1">{{ yun.startYear }}</div>
                </div>
            </div>
        </div>

    </div>
</div>

<script>
    const { createApp, ref, nextTick } = Vue;

    createApp({
        setup() {
            const form = ref({
                name: '',
                gender: 1, 
                date: new Date().toISOString().split('T')[0],
                hour: 12,
                minute: 0,
                longitude: 121.53 // å°åŒ—ç¶“åº¦
            });

            // é è¨­åŸå¸‚åˆ—è¡¨ï¼Œç”¨æ–¼çœŸå¤ªé™½æ™‚æ ¡æ­£
            const cities = [
                { name: 'å°åŒ—', lng: 121.53 }, { name: 'é«˜é›„', lng: 120.28 },
                { name: 'å°ä¸­', lng: 120.68 }, { name: 'åŒ—äº¬', lng: 116.40 },
                { name: 'ä¸Šæµ·', lng: 121.47 }, { name: 'é¦™æ¸¯', lng: 114.17 },
                { name: 'æ±äº¬', lng: 139.69 }, { name: 'ç´ç´„', lng: -74.00 },
                { name: 'å€«æ•¦', lng: -0.12 }, { name: 'é›ªæ¢¨', lng: 151.20 }
            ];
            
            const selectedCity = ref(cities[0]);
            const result = ref(null);
            const trueSolarTimeStr = ref('');
            let chartInstance = null;

            const updateLocation = () => {
                if (selectedCity.value !== 'custom') {
                    form.value.longitude = selectedCity.value.lng;
                }
            };

            const getColorClass = (wx) => ({
                'æœ¨': 'bg-wood', 'ç«': 'bg-fire', 'åœŸ': 'bg-earth', 'é‡‘': 'bg-metal', 'æ°´': 'bg-water'
            }[wx] || 'bg-gray-100');

            const getColorText = (wx) => ({
                'æœ¨': 'text-green-700', 'ç«': 'text-red-700', 'åœŸ': 'text-yellow-700', 'é‡‘': 'text-gray-700', 'æ°´': 'text-blue-700'
            }[wx] || 'text-gray-700');

            const calculate = async () => {
                try {
                    // 1. æª¢æŸ¥ç¨‹å¼åº«æ˜¯å¦è¼‰å…¥
                    if (typeof window.Solar === 'undefined' || typeof window.Lunar === 'undefined') {
                        throw new Error("ç³»çµ±æ ¸å¿ƒæ­£åœ¨è¼‰å…¥ä¸­ï¼Œè«‹ç¨ç­‰ 2 ç§’å¾Œå†è©¦...");
                    }
                    
                    const Solar = window.Solar;
                    const Lunar = window.Lunar;

                    // 2. è¨ˆç®—çœŸå¤ªé™½æ™‚æ ¡æ­£
                    const [y, m, d] = form.value.date.split('-').map(Number);
                    // ç¶“åº¦æ™‚å·®ï¼š(ç•¶åœ°ç¶“åº¦ - 120) * 4 åˆ†é˜
                    const offsetMinutes = (form.value.longitude - 120) * 4;
                    
                    let jsDate = new Date(y, m - 1, d, form.value.hour, form.value.minute);
                    jsDate.setMinutes(jsDate.getMinutes() + offsetMinutes);

                    // æ›´æ–°é¡¯ç¤ºæ–‡å­—
                    trueSolarTimeStr.value = `${jsDate.getHours().toString().padStart(2,'0')}:${jsDate.getMinutes().toString().padStart(2,'0')}`;

                    // 3. ä½¿ç”¨æ ¡æ­£å¾Œçš„æ™‚é–“æ’ç›¤
                    const solar = Solar.fromYmdHms(
                        jsDate.getFullYear(), 
                        jsDate.getMonth() + 1, 
                        jsDate.getDate(), 
                        jsDate.getHours(), 
                        jsDate.getMinutes(), 
                        0
                    );
                    
                    const lunar = solar.getLunar();
                    const eightChar = lunar.getEightChar();
                    // è¨­å®šæµæ´¾
                    eightChar.setSect(2); 

                    // 4. çµ„åˆè³‡æ–™ (æ ¸å¿ƒä¿®æ­£éƒ¨åˆ†)
                    
                    // â˜… å–å¾—æ—¥ä¸»å¤©å¹²ä½œç‚ºåç¥è¨ˆç®—çš„åŸºæº–
                    const dayGan = eightChar.getDayGan();

                    const pillars = [];
                    const parts = [
                        // å¹´æŸ±åç¥è¨ˆç®—: ä½¿ç”¨å¹´å¹²èˆ‡æ—¥ä¸»å¤©å¹²æ¯”è¼ƒ
                        { 
                            g: eightChar.getYearGan(), 
                            z: eightChar.getYearZhi(), 
                            god: eightChar.getYearGan().getShiShen(dayGan).getName()
                        },
                        // æœˆæŸ±åç¥è¨ˆç®—: ä½¿ç”¨æœˆå¹²èˆ‡æ—¥ä¸»å¤©å¹²æ¯”è¼ƒ
                        { 
                            g: eightChar.getMonthGan(), 
                            z: eightChar.getMonthZhi(), 
                            god: eightChar.getMonthGan().getShiShen(dayGan).getName()
                        },
                        // æ—¥æŸ±
                        { 
                            g: eightChar.getDayGan(), 
                            z: eightChar.getDayZhi(), 
                            god: 'æ—¥ä¸»' 
                        },
                        // æ™‚æŸ±åç¥è¨ˆç®—: ä½¿ç”¨æ™‚å¹²èˆ‡æ—¥ä¸»å¤©å¹²æ¯”è¼ƒ
                        { 
                            g: eightChar.getTimeGan(), 
                            z: eightChar.getTimeZhi(), 
                            god: eightChar.getTimeGan().getShiShen(dayGan).getName()
                        }
                    ];

                    // äº”è¡Œè¨ˆåˆ† (åŸºç¤åˆ†)
                    let scores = { 'æœ¨': 0, 'ç«': 0, 'åœŸ': 0, 'é‡‘': 0, 'æ°´': 0 };

                    parts.forEach(p => {
                        const ganWx = p.g.getWuXing();
                        const zhiWx = p.z.getWuXing();
                        
                        // ç°¡å–®è¨ˆåˆ†
                        scores[ganWx] += 10;
                        scores[zhiWx] += 10;

                        // è—å¹²è³‡è¨Š
                        const hidden = p.z.getHiddenGan().map(h => h.getName());
                        // å¯ä»¥åœ¨é€™è£¡åŠ å…¥è—å¹²çš„åç¥å’Œäº”è¡Œï¼Œç›®å‰åªé¡¯ç¤ºå¤©å¹²åç¨±

                        pillars.push({
                            gan: p.g.getName(), ganWX: ganWx, ganGod: p.god,
                            zhi: p.z.getName(), zhiWX: zhiWx, hidden
                        });
                    });

                    // è¨ˆç®—äº”è¡Œæœ€å¤§å€¼
                    let maxVal = -1;
                    let maxName = '';
                    for (const [k, v] of Object.entries(scores)) {
                        if (v > maxVal) { maxVal = v; maxName = k; }
                    }

                    // å¤§é‹
                    const yun = eightChar.getYun(form.value.gender);
                    const daYun = yun.getDaYun().slice(0, 8).map(dy => ({
                        startAge: dy.getStartAge(),
                        startYear: dy.getStartYear(),
                        gan: dy.getGanZhi().charAt(0),
                        zhi: dy.getGanZhi().charAt(1),
                        ganWX: Lunar.getGan(dy.getGanZhi().charAt(0)).getWuXing(),
                        zhiWX: Lunar.getZhi(dy.getGanZhi().charAt(1)).getWuXing()
                    }));

                    result.value = {
                        lunarDate: lunar.toString(),
                        zodiac: lunar.getYearShengXiao(),
                        solarTerm: lunar.getJieQi() || 'ç„¡',
                        pillars,
                        scores: { data: scores, max: { name: maxName } },
                        daYun
                    };

                    // 5. ç­‰å¾… DOM æ›´æ–°å¾Œç¹ªè£½åœ–è¡¨
                    await nextTick();
                    renderChart(scores);

                } catch (e) {
                    alert("æ’ç›¤ç™¼ç”ŸéŒ¯èª¤: " + e.message);
                    console.error(e);
                }
            };

            const renderChart = (scores) => {
                const ctx = document.getElementById('fiveElementChart');
                if (!ctx) return;

                if (chartInstance) chartInstance.destroy();

                chartInstance = new Chart(ctx, {
                    type: 'radar',
                    data: {
                        labels: ['æœ¨', 'ç«', 'åœŸ', 'é‡‘', 'æ°´'],
                        datasets: [{
                            label: 'èƒ½é‡åˆ†ä½ˆ',
                            data: [scores['æœ¨'], scores['ç«'], scores['åœŸ'], scores['é‡‘'], scores['æ°´']],
                            backgroundColor: 'rgba(79, 70, 229, 0.2)',
                            borderColor: 'rgba(79, 70, 229, 1)',
                            pointBackgroundColor: '#4f46e5',
                            pointBorderColor: '#fff'
                        }]
                    },
                    options: {
                        scales: {
                            r: {
                                beginAtZero: true,
                                ticks: { display: false }
                            }
                        },
                        plugins: {
                            legend: { display: false }
                        }
                    }
                });
            };

            return {
                form, cities, selectedCity, result, trueSolarTimeStr,
                updateLocation, calculate, getColorClass, getColorText
            };
        }
    }).mount('#app');
</script>

</body>
</html>
